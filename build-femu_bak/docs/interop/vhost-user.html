
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Vhost-user Protocol &#8212; QEMU  documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Vhost-user-gpu Protocol" href="vhost-user-gpu.html" />
    <link rel="prev" title="QEMU QMP Reference Manual" href="qemu-qmp-ref.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="vhost-user-protocol">
<h1><a class="toc-backref" href="#id2">Vhost-user Protocol</a><a class="headerlink" href="#vhost-user-protocol" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Copyright:</th><td class="field-body">2014 Virtual Open Systems Sarl.</td>
</tr>
<tr class="field-even field"><th class="field-name">Copyright:</th><td class="field-body">2019 Intel Corporation</td>
</tr>
<tr class="field-odd field"><th class="field-name">Licence:</th><td class="field-body">This work is licensed under the terms of the GNU GPL,
version 2 or later. See the COPYING file in the top-level
directory.</td>
</tr>
</tbody>
</table>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#vhost-user-protocol" id="id2">Vhost-user Protocol</a><ul>
<li><a class="reference internal" href="#introduction" id="id3">Introduction</a></li>
<li><a class="reference internal" href="#message-specification" id="id4">Message Specification</a><ul>
<li><a class="reference internal" href="#header" id="id5">Header</a></li>
<li><a class="reference internal" href="#payload" id="id6">Payload</a><ul>
<li><a class="reference internal" href="#a-single-64-bit-integer" id="id7">A single 64-bit integer</a></li>
<li><a class="reference internal" href="#a-vring-state-description" id="id8">A vring state description</a></li>
<li><a class="reference internal" href="#a-vring-address-description" id="id9">A vring address description</a></li>
<li><a class="reference internal" href="#memory-regions-description" id="id10">Memory regions description</a></li>
<li><a class="reference internal" href="#single-memory-region-description" id="id11">Single memory region description</a></li>
<li><a class="reference internal" href="#log-description" id="id12">Log description</a></li>
<li><a class="reference internal" href="#an-iotlb-message" id="id13">An IOTLB message</a></li>
<li><a class="reference internal" href="#virtio-device-config-space" id="id14">Virtio device config space</a></li>
<li><a class="reference internal" href="#vring-area-description" id="id15">Vring area description</a></li>
<li><a class="reference internal" href="#inflight-description" id="id16">Inflight description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#c-structure" id="id17">C structure</a></li>
</ul>
</li>
<li><a class="reference internal" href="#communication" id="id18">Communication</a><ul>
<li><a class="reference internal" href="#starting-and-stopping-rings" id="id19">Starting and stopping rings</a></li>
<li><a class="reference internal" href="#multiple-queue-support" id="id20">Multiple queue support</a></li>
<li><a class="reference internal" href="#migration" id="id21">Migration</a></li>
<li><a class="reference internal" href="#memory-access" id="id22">Memory access</a></li>
<li><a class="reference internal" href="#iommu-support" id="id23">IOMMU support</a></li>
<li><a class="reference internal" href="#slave-communication" id="id24">Slave communication</a></li>
<li><a class="reference internal" href="#inflight-i-o-tracking" id="id25">Inflight I/O tracking</a></li>
<li><a class="reference internal" href="#in-band-notifications" id="id26">In-band notifications</a></li>
<li><a class="reference internal" href="#protocol-features" id="id27">Protocol features</a></li>
<li><a class="reference internal" href="#master-message-types" id="id28">Master message types</a></li>
<li><a class="reference internal" href="#slave-message-types" id="id29">Slave message types</a></li>
<li><a class="reference internal" href="#vhost-user-protocol-f-reply-ack" id="id30">VHOST_USER_PROTOCOL_F_REPLY_ACK</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backend-program-conventions" id="id31">Backend program conventions</a><ul>
<li><a class="reference internal" href="#vhost-user-input" id="id32">vhost-user-input</a></li>
<li><a class="reference internal" href="#vhost-user-gpu" id="id33">vhost-user-gpu</a></li>
<li><a class="reference internal" href="#vhost-user-blk" id="id34">vhost-user-blk</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id3">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This protocol is aiming to complement the <code class="docutils literal notranslate"><span class="pre">ioctl</span></code> interface used to
control the vhost implementation in the Linux kernel. It implements
the control plane needed to establish virtqueue sharing with a user
space process on the same host. It uses communication over a Unix
domain socket to share file descriptors in the ancillary data of the
message.</p>
<p>The protocol defines 2 sides of the communication, <em>master</em> and
<em>slave</em>. <em>Master</em> is the application that shares its virtqueues, in
our case QEMU. <em>Slave</em> is the consumer of the virtqueues.</p>
<p>In the current implementation QEMU is the <em>master</em>, and the <em>slave</em> is
the external process consuming the virtio queues, for example a
software Ethernet switch running in user space, such as Snabbswitch,
or a block device backend processing read &amp; write to a virtual
disk. In order to facilitate interoperability between various backend
implementations, it is recommended to follow the <a class="reference internal" href="#backend-conventions"><span class="std std-ref">Backend program
conventions</span></a>.</p>
<p><em>Master</em> and <em>slave</em> can be either a client (i.e. connecting) or
server (listening) in the socket communication.</p>
</div>
<div class="section" id="message-specification">
<h2><a class="toc-backref" href="#id4">Message Specification</a><a class="headerlink" href="#message-specification" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All numbers are in the machine native byte order.</p>
</div>
<p>A vhost-user message consists of 3 header fields and a payload.</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="23%" />
<col width="19%" />
<col width="29%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>request</td>
<td>flags</td>
<td>size</td>
<td>payload</td>
</tr>
</tbody>
</table>
<div class="section" id="header">
<h3><a class="toc-backref" href="#id5">Header</a><a class="headerlink" href="#header" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">request:</th><td class="field-body">32-bit type of the request</td>
</tr>
<tr class="field-even field"><th class="field-name">flags:</th><td class="field-body">32-bit bit field</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>Lower 2 bits are the version (currently 0x01)</li>
<li>Bit 2 is the reply flag - needs to be sent on each reply from the slave</li>
<li>Bit 3 is the need_reply flag - see <a class="reference internal" href="#reply-ack"><span class="std std-ref">REPLY_ACK</span></a> for
details.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">size:</th><td class="field-body">32-bit size of the payload</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="payload">
<h3><a class="toc-backref" href="#id6">Payload</a><a class="headerlink" href="#payload" title="Permalink to this headline">¶</a></h3>
<p>Depending on the request type, <strong>payload</strong> can be:</p>
<div class="section" id="a-single-64-bit-integer">
<h4><a class="toc-backref" href="#id7">A single 64-bit integer</a><a class="headerlink" href="#a-single-64-bit-integer" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>u64</td>
</tr>
</tbody>
</table>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">u64:</th><td class="field-body">a 64-bit unsigned integer</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="a-vring-state-description">
<h4><a class="toc-backref" href="#id8">A vring state description</a><a class="headerlink" href="#a-vring-state-description" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="58%" />
<col width="42%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>index</td>
<td>num</td>
</tr>
</tbody>
</table>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">index:</th><td class="field-body">a 32-bit index</td>
</tr>
<tr class="field-even field"><th class="field-name">num:</th><td class="field-body">a 32-bit number</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="a-vring-address-description">
<h4><a class="toc-backref" href="#id9">A vring address description</a><a class="headerlink" href="#a-vring-address-description" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="13%" />
<col width="11%" />
<col width="22%" />
<col width="11%" />
<col width="20%" />
<col width="9%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>index</td>
<td>flags</td>
<td>size</td>
<td>descriptor</td>
<td>used</td>
<td>available</td>
<td>log</td>
</tr>
</tbody>
</table>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">index:</th><td class="field-body">a 32-bit vring index</td>
</tr>
<tr class="field-even field"><th class="field-name">flags:</th><td class="field-body">a 32-bit vring flags</td>
</tr>
<tr class="field-odd field"><th class="field-name">descriptor:</th><td class="field-body">a 64-bit ring address of the vring descriptor table</td>
</tr>
<tr class="field-even field"><th class="field-name">used:</th><td class="field-body">a 64-bit ring address of the vring used ring</td>
</tr>
<tr class="field-odd field"><th class="field-name">available:</th><td class="field-body">a 64-bit ring address of the vring available ring</td>
</tr>
<tr class="field-even field"><th class="field-name">log:</th><td class="field-body">a 64-bit guest address for logging</td>
</tr>
</tbody>
</table>
<p>Note that a ring address is an IOVA if <code class="docutils literal notranslate"><span class="pre">VIRTIO_F_IOMMU_PLATFORM</span></code> has
been negotiated. Otherwise it is a user address.</p>
</div>
<div class="section" id="memory-regions-description">
<h4><a class="toc-backref" href="#id10">Memory regions description</a><a class="headerlink" href="#memory-regions-description" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="20%" />
<col width="20%" />
<col width="11%" />
<col width="20%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>num regions</td>
<td>padding</td>
<td>region0</td>
<td>…</td>
<td>region7</td>
</tr>
</tbody>
</table>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">num regions:</th><td class="field-body">a 32-bit number of regions</td>
</tr>
<tr class="field-even field"><th class="field-name">padding:</th><td class="field-body">32-bit</td>
</tr>
</tbody>
</table>
<p>A region is:</p>
<table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="13%" />
<col width="29%" />
<col width="27%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>guest address</td>
<td>size</td>
<td>user address</td>
<td>mmap offset</td>
</tr>
</tbody>
</table>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">guest address:</th><td class="field-body">a 64-bit guest address of the region</td>
</tr>
<tr class="field-even field"><th class="field-name">size:</th><td class="field-body">a 64-bit size</td>
</tr>
<tr class="field-odd field"><th class="field-name">user address:</th><td class="field-body">a 64-bit user address</td>
</tr>
<tr class="field-even field"><th class="field-name">mmap offset:</th><td class="field-body">64-bit offset where region starts in the mapped memory</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="single-memory-region-description">
<h4><a class="toc-backref" href="#id11">Single memory region description</a><a class="headerlink" href="#single-memory-region-description" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="26%" />
<col width="11%" />
<col width="25%" />
<col width="23%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>padding</td>
<td>guest address</td>
<td>size</td>
<td>user address</td>
<td>mmap offset</td>
</tr>
</tbody>
</table>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">padding:</th><td class="field-body">64-bit</td>
</tr>
<tr class="field-even field"><th class="field-name">guest address:</th><td class="field-body">a 64-bit guest address of the region</td>
</tr>
<tr class="field-odd field"><th class="field-name">size:</th><td class="field-body">a 64-bit size</td>
</tr>
<tr class="field-even field"><th class="field-name">user address:</th><td class="field-body">a 64-bit user address</td>
</tr>
<tr class="field-odd field"><th class="field-name">mmap offset:</th><td class="field-body">64-bit offset where region starts in the mapped memory</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="log-description">
<h4><a class="toc-backref" href="#id12">Log description</a><a class="headerlink" href="#log-description" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="45%" />
<col width="55%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>log size</td>
<td>log offset</td>
</tr>
</tbody>
</table>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">log size:</th><td class="field-body">size of area used for logging</td>
</tr>
<tr class="field-even field"><th class="field-name">log offset:</th><td class="field-body">offset from start of supplied file descriptor where
logging starts (i.e. where guest address 0 would be
logged)</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="an-iotlb-message">
<h4><a class="toc-backref" href="#id13">An IOTLB message</a><a class="headerlink" href="#an-iotlb-message" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="12%" />
<col width="27%" />
<col width="37%" />
<col width="12%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>iova</td>
<td>size</td>
<td>user address</td>
<td>permissions flags</td>
<td>type</td>
</tr>
</tbody>
</table>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">iova:</th><td class="field-body">a 64-bit I/O virtual address programmed by the guest</td>
</tr>
<tr class="field-even field"><th class="field-name">size:</th><td class="field-body">a 64-bit size</td>
</tr>
<tr class="field-odd field"><th class="field-name">user address:</th><td class="field-body">a 64-bit user address</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">permissions flags:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">an 8-bit value:
- 0: No access
- 1: Read access
- 2: Write access
- 3: Read/Write access</td>
</tr>
<tr class="field-odd field"><th class="field-name">type:</th><td class="field-body">an 8-bit IOTLB message type:
- 1: IOTLB miss
- 2: IOTLB update
- 3: IOTLB invalidate
- 4: IOTLB access fail</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="virtio-device-config-space">
<h4><a class="toc-backref" href="#id14">Virtio device config space</a><a class="headerlink" href="#virtio-device-config-space" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="27%" />
<col width="20%" />
<col width="23%" />
<col width="30%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>offset</td>
<td>size</td>
<td>flags</td>
<td>payload</td>
</tr>
</tbody>
</table>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">offset:</th><td class="field-body">a 32-bit offset of virtio device’s configuration space</td>
</tr>
<tr class="field-even field"><th class="field-name">size:</th><td class="field-body">a 32-bit configuration space access size in bytes</td>
</tr>
<tr class="field-odd field"><th class="field-name">flags:</th><td class="field-body">a 32-bit value:
- 0: Vhost master messages used for writeable fields
- 1: Vhost master messages used for live migration</td>
</tr>
<tr class="field-even field"><th class="field-name">payload:</th><td class="field-body">Size bytes array holding the contents of the virtio
device’s configuration space</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="vring-area-description">
<h4><a class="toc-backref" href="#id15">Vring area description</a><a class="headerlink" href="#vring-area-description" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="32%" />
<col width="42%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>u64</td>
<td>size</td>
<td>offset</td>
</tr>
</tbody>
</table>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">u64:</th><td class="field-body">a 64-bit integer contains vring index and flags</td>
</tr>
<tr class="field-even field"><th class="field-name">size:</th><td class="field-body">a 64-bit size of this area</td>
</tr>
<tr class="field-odd field"><th class="field-name">offset:</th><td class="field-body">a 64-bit offset of this area from the start of the
supplied file descriptor</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="inflight-description">
<h4><a class="toc-backref" href="#id16">Inflight description</a><a class="headerlink" href="#inflight-description" title="Permalink to this headline">¶</a></h4>
<table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="27%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>mmap size</td>
<td>mmap offset</td>
<td>num queues</td>
<td>queue size</td>
</tr>
</tbody>
</table>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">mmap size:</th><td class="field-body">a 64-bit size of area to track inflight I/O</td>
</tr>
<tr class="field-even field"><th class="field-name">mmap offset:</th><td class="field-body">a 64-bit offset of this area from the start
of the supplied file descriptor</td>
</tr>
<tr class="field-odd field"><th class="field-name">num queues:</th><td class="field-body">a 16-bit number of virtqueues</td>
</tr>
<tr class="field-even field"><th class="field-name">queue size:</th><td class="field-body">a 16-bit size of virtqueues</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="c-structure">
<h3><a class="toc-backref" href="#id17">C structure</a><a class="headerlink" href="#c-structure" title="Permalink to this headline">¶</a></h3>
<p>In QEMU the vhost-user message is implemented with the following struct:</p>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="n">struct</span> <span class="n">VhostUserMsg</span> <span class="p">{</span>
    <span class="n">VhostUserRequest</span> <span class="n">request</span><span class="p">;</span>
    <span class="n">uint32_t</span> <span class="n">flags</span><span class="p">;</span>
    <span class="n">uint32_t</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">union</span> <span class="p">{</span>
        <span class="n">uint64_t</span> <span class="n">u64</span><span class="p">;</span>
        <span class="n">struct</span> <span class="n">vhost_vring_state</span> <span class="n">state</span><span class="p">;</span>
        <span class="n">struct</span> <span class="n">vhost_vring_addr</span> <span class="n">addr</span><span class="p">;</span>
        <span class="n">VhostUserMemory</span> <span class="n">memory</span><span class="p">;</span>
        <span class="n">VhostUserLog</span> <span class="n">log</span><span class="p">;</span>
        <span class="n">struct</span> <span class="n">vhost_iotlb_msg</span> <span class="n">iotlb</span><span class="p">;</span>
        <span class="n">VhostUserConfig</span> <span class="n">config</span><span class="p">;</span>
        <span class="n">VhostUserVringArea</span> <span class="n">area</span><span class="p">;</span>
        <span class="n">VhostUserInflight</span> <span class="n">inflight</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span> <span class="n">QEMU_PACKED</span> <span class="n">VhostUserMsg</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="communication">
<h2><a class="toc-backref" href="#id18">Communication</a><a class="headerlink" href="#communication" title="Permalink to this headline">¶</a></h2>
<p>The protocol for vhost-user is based on the existing implementation of
vhost for the Linux Kernel. Most messages that can be sent via the
Unix domain socket implementing vhost-user have an equivalent ioctl to
the kernel implementation.</p>
<p>The communication consists of <em>master</em> sending message requests and
<em>slave</em> sending message replies. Most of the requests don’t require
replies. Here is a list of the ones that do:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_FEATURES</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_PROTOCOL_FEATURES</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_VRING_BASE</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_LOG_BASE</span></code> (if <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_LOG_SHMFD</span></code>)</li>
<li><code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_INFLIGHT_FD</span></code> (if <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_INFLIGHT_SHMFD</span></code>)</li>
</ul>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="#reply-ack"><span class="std std-ref">REPLY_ACK</span></a></dt>
<dd>The section on <code class="docutils literal notranslate"><span class="pre">REPLY_ACK</span></code> protocol extension.</dd>
</dl>
</div>
<p>There are several messages that the master sends with file descriptors passed
in the ancillary data:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_MEM_TABLE</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_LOG_BASE</span></code> (if <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_LOG_SHMFD</span></code>)</li>
<li><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_LOG_FD</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_KICK</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_CALL</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_ERR</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_SLAVE_REQ_FD</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_INFLIGHT_FD</span></code> (if <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_INFLIGHT_SHMFD</span></code>)</li>
</ul>
<p>If <em>master</em> is unable to send the full message or receives a wrong
reply it will close the connection. An optional reconnection mechanism
can be implemented.</p>
<p>If <em>slave</em> detects some error such as incompatible features, it may also
close the connection. This should only happen in exceptional circumstances.</p>
<p>Any protocol extensions are gated by protocol feature bits, which
allows full backwards compatibility on both master and slave.  As
older slaves don’t support negotiating protocol features, a feature
bit was dedicated for this purpose:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define VHOST_USER_F_PROTOCOL_FEATURES 30</span>
</pre></div>
</div>
<div class="section" id="starting-and-stopping-rings">
<h3><a class="toc-backref" href="#id19">Starting and stopping rings</a><a class="headerlink" href="#starting-and-stopping-rings" title="Permalink to this headline">¶</a></h3>
<p>Client must only process each ring when it is started.</p>
<p>Client must only pass data between the ring and the backend, when the
ring is enabled.</p>
<p>If ring is started but disabled, client must process the ring without
talking to the backend.</p>
<p>For example, for a networking device, in the disabled state client
must not supply any new RX packets, but must process and discard any
TX packets.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">VHOST_USER_F_PROTOCOL_FEATURES</span></code> has not been negotiated, the
ring is initialized in an enabled state.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">VHOST_USER_F_PROTOCOL_FEATURES</span></code> has been negotiated, the ring is
initialized in a disabled state. Client must not pass data to/from the
backend until ring is enabled by <code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_ENABLE</span></code> with
parameter 1, or after it has been disabled by
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_ENABLE</span></code> with parameter 0.</p>
<p>Each ring is initialized in a stopped state, client must not process
it until ring is started, or after it has been stopped.</p>
<p>Client must start ring upon receiving a kick (that is, detecting that
file descriptor is readable) on the descriptor specified by
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_KICK</span></code> or receiving the in-band message
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_VRING_KICK</span></code> if negotiated, and stop ring upon receiving
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_VRING_BASE</span></code>.</p>
<p>While processing the rings (whether they are enabled or not), client
must support changing some configuration aspects on the fly.</p>
</div>
<div class="section" id="multiple-queue-support">
<h3><a class="toc-backref" href="#id20">Multiple queue support</a><a class="headerlink" href="#multiple-queue-support" title="Permalink to this headline">¶</a></h3>
<p>Many devices have a fixed number of virtqueues.  In this case the master
already knows the number of available virtqueues without communicating with the
slave.</p>
<p>Some devices do not have a fixed number of virtqueues.  Instead the maximum
number of virtqueues is chosen by the slave.  The number can depend on host
resource availability or slave implementation details.  Such devices are called
multiple queue devices.</p>
<p>Multiple queue support allows the slave to advertise the maximum number of
queues.  This is treated as a protocol extension, hence the slave has to
implement protocol features first. The multiple queues feature is supported
only when the protocol feature <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_MQ</span></code> (bit 0) is set.</p>
<p>The max number of queues the slave supports can be queried with message
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_QUEUE_NUM</span></code>. Master should stop when the number of requested
queues is bigger than that.</p>
<p>As all queues share one connection, the master uses a unique index for each
queue in the sent message to identify a specified queue.</p>
<p>The master enables queues by sending message <code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_ENABLE</span></code>.
vhost-user-net has historically automatically enabled the first queue pair.</p>
<p>Slaves should always implement the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_MQ</span></code> protocol
feature, even for devices with a fixed number of virtqueues, since it is simple
to implement and offers a degree of introspection.</p>
<p>Masters must not rely on the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_MQ</span></code> protocol feature for
devices with a fixed number of virtqueues.  Only true multiqueue devices
require this protocol feature.</p>
</div>
<div class="section" id="migration">
<h3><a class="toc-backref" href="#id21">Migration</a><a class="headerlink" href="#migration" title="Permalink to this headline">¶</a></h3>
<p>During live migration, the master may need to track the modifications
the slave makes to the memory mapped regions. The client should mark
the dirty pages in a log. Once it complies to this logging, it may
declare the <code class="docutils literal notranslate"><span class="pre">VHOST_F_LOG_ALL</span></code> vhost feature.</p>
<p>To start/stop logging of data/used ring writes, server may send
messages <code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_FEATURES</span></code> with <code class="docutils literal notranslate"><span class="pre">VHOST_F_LOG_ALL</span></code> and
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_ADDR</span></code> with <code class="docutils literal notranslate"><span class="pre">VHOST_VRING_F_LOG</span></code> in ring’s
flags set to 1/0, respectively.</p>
<p>All the modifications to memory pointed by vring “descriptor” should
be marked. Modifications to “used” vring should be marked if
<code class="docutils literal notranslate"><span class="pre">VHOST_VRING_F_LOG</span></code> is part of ring’s flags.</p>
<p>Dirty pages are of size:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define VHOST_LOG_PAGE 0x1000</span>
</pre></div>
</div>
<p>The log memory fd is provided in the ancillary data of
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_LOG_BASE</span></code> message when the slave has
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_LOG_SHMFD</span></code> protocol feature.</p>
<p>The size of the log is supplied as part of <code class="docutils literal notranslate"><span class="pre">VhostUserMsg</span></code> which
should be large enough to cover all known guest addresses. Log starts
at the supplied offset in the supplied file descriptor.  The log
covers from address 0 to the maximum of guest regions. In pseudo-code,
to mark page at <code class="docutils literal notranslate"><span class="pre">addr</span></code> as dirty:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">page</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">/</span> <span class="n">VHOST_LOG_PAGE</span>
<span class="n">log</span><span class="p">[</span><span class="n">page</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">page</span> <span class="o">%</span> <span class="mi">8</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">addr</span></code> is the guest physical address.</p>
<p>Use atomic operations, as the log may be concurrently manipulated.</p>
<p>Note that when logging modifications to the used ring (when
<code class="docutils literal notranslate"><span class="pre">VHOST_VRING_F_LOG</span></code> is set for this ring), <code class="docutils literal notranslate"><span class="pre">log_guest_addr</span></code> should
be used to calculate the log offset: the write to first byte of the
used ring is logged at this offset from log start. Also note that this
value might be outside the legal guest physical address range
(i.e. does not have to be covered by the <code class="docutils literal notranslate"><span class="pre">VhostUserMemory</span></code> table), but
the bit offset of the last byte of the ring must fall within the size
supplied by <code class="docutils literal notranslate"><span class="pre">VhostUserLog</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_LOG_FD</span></code> is an optional message with an eventfd in
ancillary data, it may be used to inform the master that the log has
been modified.</p>
<p>Once the source has finished migration, rings will be stopped by the
source. No further update must be done before rings are restarted.</p>
<p>In postcopy migration the slave is started before all the memory has
been received from the source host, and care must be taken to avoid
accessing pages that have yet to be received.  The slave opens a
‘userfault’-fd and registers the memory with it; this fd is then
passed back over to the master.  The master services requests on the
userfaultfd for pages that are accessed and when the page is available
it performs WAKE ioctl’s on the userfaultfd to wake the stalled
slave.  The client indicates support for this via the
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_PAGEFAULT</span></code> feature.</p>
</div>
<div class="section" id="memory-access">
<h3><a class="toc-backref" href="#id22">Memory access</a><a class="headerlink" href="#memory-access" title="Permalink to this headline">¶</a></h3>
<p>The master sends a list of vhost memory regions to the slave using the
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_MEM_TABLE</span></code> message.  Each region has two base
addresses: a guest address and a user address.</p>
<p>Messages contain guest addresses and/or user addresses to reference locations
within the shared memory.  The mapping of these addresses works as follows.</p>
<p>User addresses map to the vhost memory region containing that user address.</p>
<p>When the <code class="docutils literal notranslate"><span class="pre">VIRTIO_F_IOMMU_PLATFORM</span></code> feature has not been negotiated:</p>
<ul class="simple">
<li>Guest addresses map to the vhost memory region containing that guest
address.</li>
</ul>
<p>When the <code class="docutils literal notranslate"><span class="pre">VIRTIO_F_IOMMU_PLATFORM</span></code> feature has been negotiated:</p>
<ul class="simple">
<li>Guest addresses are also called I/O virtual addresses (IOVAs).  They are
translated to user addresses via the IOTLB.</li>
<li>The vhost memory region guest address is not used.</li>
</ul>
</div>
<div class="section" id="iommu-support">
<h3><a class="toc-backref" href="#id23">IOMMU support</a><a class="headerlink" href="#iommu-support" title="Permalink to this headline">¶</a></h3>
<p>When the <code class="docutils literal notranslate"><span class="pre">VIRTIO_F_IOMMU_PLATFORM</span></code> feature has been negotiated, the
master sends IOTLB entries update &amp; invalidation by sending
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_IOTLB_MSG</span></code> requests to the slave with a <code class="docutils literal notranslate"><span class="pre">struct</span>
<span class="pre">vhost_iotlb_msg</span></code> as payload. For update events, the <code class="docutils literal notranslate"><span class="pre">iotlb</span></code> payload
has to be filled with the update message type (2), the I/O virtual
address, the size, the user virtual address, and the permissions
flags. Addresses and size must be within vhost memory regions set via
the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_MEM_TABLE</span></code> request. For invalidation events, the
<code class="docutils literal notranslate"><span class="pre">iotlb</span></code> payload has to be filled with the invalidation message type
(3), the I/O virtual address and the size. On success, the slave is
expected to reply with a zero payload, non-zero otherwise.</p>
<p>The slave relies on the slave communication channel (see <a class="reference internal" href="#slave-communication"><span class="std std-ref">Slave
communication</span></a> section below) to send IOTLB miss
and access failure events, by sending <code class="docutils literal notranslate"><span class="pre">VHOST_USER_SLAVE_IOTLB_MSG</span></code>
requests to the master with a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">vhost_iotlb_msg</span></code> as
payload. For miss events, the iotlb payload has to be filled with the
miss message type (1), the I/O virtual address and the permissions
flags. For access failure event, the iotlb payload has to be filled
with the access failure message type (4), the I/O virtual address and
the permissions flags.  For synchronization purpose, the slave may
rely on the reply-ack feature, so the master may send a reply when
operation is completed if the reply-ack feature is negotiated and
slaves requests a reply. For miss events, completed operation means
either master sent an update message containing the IOTLB entry
containing requested address and permission, or master sent nothing if
the IOTLB miss message is invalid (invalid IOVA or permission).</p>
<p>The master isn’t expected to take the initiative to send IOTLB update
messages, as the slave sends IOTLB miss messages for the guest virtual
memory areas it needs to access.</p>
</div>
<div class="section" id="slave-communication">
<span id="id1"></span><h3><a class="toc-backref" href="#id24">Slave communication</a><a class="headerlink" href="#slave-communication" title="Permalink to this headline">¶</a></h3>
<p>An optional communication channel is provided if the slave declares
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_SLAVE_REQ</span></code> protocol feature, to allow the
slave to make requests to the master.</p>
<p>The fd is provided via <code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_SLAVE_REQ_FD</span></code> ancillary data.</p>
<p>A slave may then send <code class="docutils literal notranslate"><span class="pre">VHOST_USER_SLAVE_*</span></code> messages to the master
using this fd communication channel.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_SLAVE_SEND_FD</span></code> protocol feature is
negotiated, slave can send file descriptors (at most 8 descriptors in
each message) to master via ancillary data using this fd communication
channel.</p>
</div>
<div class="section" id="inflight-i-o-tracking">
<h3><a class="toc-backref" href="#id25">Inflight I/O tracking</a><a class="headerlink" href="#inflight-i-o-tracking" title="Permalink to this headline">¶</a></h3>
<p>To support reconnecting after restart or crash, slave may need to
resubmit inflight I/Os. If virtqueue is processed in order, we can
easily achieve that by getting the inflight descriptors from
descriptor table (split virtqueue) or descriptor ring (packed
virtqueue). However, it can’t work when we process descriptors
out-of-order because some entries which store the information of
inflight descriptors in available ring (split virtqueue) or descriptor
ring (packed virtqueue) might be overridden by new entries. To solve
this problem, slave need to allocate an extra buffer to store this
information of inflight descriptors and share it with master for
persistent. <code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_INFLIGHT_FD</span></code> and
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_INFLIGHT_FD</span></code> are used to transfer this buffer
between master and slave. And the format of this buffer is described
below:</p>
<table border="1" class="docutils">
<colgroup>
<col width="30%" />
<col width="30%" />
<col width="10%" />
<col width="30%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>queue0 region</td>
<td>queue1 region</td>
<td>…</td>
<td>queueN region</td>
</tr>
</tbody>
</table>
<p>N is the number of available virtqueues. Slave could get it from num
queues field of <code class="docutils literal notranslate"><span class="pre">VhostUserInflight</span></code>.</p>
<p>For split virtqueue, queue region can be implemented as:</p>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="n">struct</span> <span class="n">DescStateSplit</span> <span class="p">{</span>
    <span class="o">/*</span> <span class="n">Indicate</span> <span class="n">whether</span> <span class="n">this</span> <span class="n">descriptor</span> <span class="ow">is</span> <span class="n">inflight</span> <span class="ow">or</span> <span class="ow">not</span><span class="o">.</span>
     <span class="o">*</span> <span class="n">Only</span> <span class="n">available</span> <span class="k">for</span> <span class="n">head</span><span class="o">-</span><span class="n">descriptor</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">uint8_t</span> <span class="n">inflight</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">Padding</span> <span class="o">*/</span>
    <span class="n">uint8_t</span> <span class="n">padding</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

    <span class="o">/*</span> <span class="n">Maintain</span> <span class="n">a</span> <span class="nb">list</span> <span class="k">for</span> <span class="n">the</span> <span class="n">last</span> <span class="n">batch</span> <span class="n">of</span> <span class="n">used</span> <span class="n">descriptors</span><span class="o">.</span>
     <span class="o">*</span> <span class="n">Only</span> <span class="n">available</span> <span class="n">when</span> <span class="n">batching</span> <span class="ow">is</span> <span class="n">used</span> <span class="k">for</span> <span class="n">submitting</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="nb">next</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">Used</span> <span class="n">to</span> <span class="n">preserve</span> <span class="n">the</span> <span class="n">order</span> <span class="n">of</span> <span class="n">fetching</span> <span class="n">available</span> <span class="n">descriptors</span><span class="o">.</span>
     <span class="o">*</span> <span class="n">Only</span> <span class="n">available</span> <span class="k">for</span> <span class="n">head</span><span class="o">-</span><span class="n">descriptor</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">uint64_t</span> <span class="n">counter</span><span class="p">;</span>
<span class="p">}</span> <span class="n">DescStateSplit</span><span class="p">;</span>

<span class="n">typedef</span> <span class="n">struct</span> <span class="n">QueueRegionSplit</span> <span class="p">{</span>
    <span class="o">/*</span> <span class="n">The</span> <span class="n">feature</span> <span class="n">flags</span> <span class="n">of</span> <span class="n">this</span> <span class="n">region</span><span class="o">.</span> <span class="n">Now</span> <span class="n">it</span><span class="s1">&#39;s initialized to 0. */</span>
    <span class="n">uint64_t</span> <span class="n">features</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">version</span> <span class="n">of</span> <span class="n">this</span> <span class="n">region</span><span class="o">.</span> <span class="n">It</span><span class="s1">&#39;s 1 currently.</span>
     <span class="o">*</span> <span class="n">Zero</span> <span class="n">value</span> <span class="n">indicates</span> <span class="n">an</span> <span class="n">uninitialized</span> <span class="n">buffer</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="n">version</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">size</span> <span class="n">of</span> <span class="n">DescStateSplit</span> <span class="n">array</span><span class="o">.</span> <span class="n">It</span><span class="s1">&#39;s equal to the virtqueue</span>
     <span class="o">*</span> <span class="n">size</span><span class="o">.</span> <span class="n">Slave</span> <span class="n">could</span> <span class="n">get</span> <span class="n">it</span> <span class="kn">from</span> <span class="nn">queue</span> <span class="n">size</span> <span class="n">field</span> <span class="n">of</span> <span class="n">VhostUserInflight</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="n">desc_num</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">head</span> <span class="n">of</span> <span class="nb">list</span> <span class="n">that</span> <span class="n">track</span> <span class="n">the</span> <span class="n">last</span> <span class="n">batch</span> <span class="n">of</span> <span class="n">used</span> <span class="n">descriptors</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="n">last_batch_head</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">Store</span> <span class="n">the</span> <span class="n">idx</span> <span class="n">value</span> <span class="n">of</span> <span class="n">used</span> <span class="n">ring</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="n">used_idx</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">Used</span> <span class="n">to</span> <span class="n">track</span> <span class="n">the</span> <span class="n">state</span> <span class="n">of</span> <span class="n">each</span> <span class="n">descriptor</span> <span class="ow">in</span> <span class="n">descriptor</span> <span class="n">table</span> <span class="o">*/</span>
    <span class="n">DescStateSplit</span> <span class="n">desc</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">QueueRegionSplit</span><span class="p">;</span>
</pre></div>
</div>
<p>To track inflight I/O, the queue region should be processed as follows:</p>
<p>When receiving available buffers from the driver:</p>
<ol class="arabic simple">
<li>Get the next available head-descriptor index from available ring, <code class="docutils literal notranslate"><span class="pre">i</span></code></li>
<li>Set <code class="docutils literal notranslate"><span class="pre">desc[i].counter</span></code> to the value of global counter</li>
<li>Increase global counter by 1</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">desc[i].inflight</span></code> to 1</li>
</ol>
<p>When supplying used buffers to the driver:</p>
<ol class="arabic simple">
<li>Get corresponding used head-descriptor index, i</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">desc[i].next</span></code> to <code class="docutils literal notranslate"><span class="pre">last_batch_head</span></code></li>
<li>Set <code class="docutils literal notranslate"><span class="pre">last_batch_head</span></code> to <code class="docutils literal notranslate"><span class="pre">i</span></code></li>
<li>Steps 1,2,3 may be performed repeatedly if batching is possible</li>
<li>Increase the <code class="docutils literal notranslate"><span class="pre">idx</span></code> value of used ring by the size of the batch</li>
<li>Set the <code class="docutils literal notranslate"><span class="pre">inflight</span></code> field of each <code class="docutils literal notranslate"><span class="pre">DescStateSplit</span></code> entry in the batch to 0</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">used_idx</span></code> to the <code class="docutils literal notranslate"><span class="pre">idx</span></code> value of used ring</li>
</ol>
<p>When reconnecting:</p>
<ol class="arabic simple">
<li>If the value of <code class="docutils literal notranslate"><span class="pre">used_idx</span></code> does not match the <code class="docutils literal notranslate"><span class="pre">idx</span></code> value of
used ring (means the inflight field of <code class="docutils literal notranslate"><span class="pre">DescStateSplit</span></code> entries in
last batch may be incorrect),<ol class="loweralpha">
<li>Subtract the value of <code class="docutils literal notranslate"><span class="pre">used_idx</span></code> from the <code class="docutils literal notranslate"><span class="pre">idx</span></code> value of
used ring to get last batch size of <code class="docutils literal notranslate"><span class="pre">DescStateSplit</span></code> entries</li>
<li>Set the <code class="docutils literal notranslate"><span class="pre">inflight</span></code> field of each <code class="docutils literal notranslate"><span class="pre">DescStateSplit</span></code> entry to 0 in last batch
list which starts from <code class="docutils literal notranslate"><span class="pre">last_batch_head</span></code></li>
<li>Set <code class="docutils literal notranslate"><span class="pre">used_idx</span></code> to the <code class="docutils literal notranslate"><span class="pre">idx</span></code> value of used ring</li>
</ol>
</li>
<li>Resubmit inflight <code class="docutils literal notranslate"><span class="pre">DescStateSplit</span></code> entries in order of their
counter value</li>
</ol>
<p>For packed virtqueue, queue region can be implemented as:</p>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="n">struct</span> <span class="n">DescStatePacked</span> <span class="p">{</span>
    <span class="o">/*</span> <span class="n">Indicate</span> <span class="n">whether</span> <span class="n">this</span> <span class="n">descriptor</span> <span class="ow">is</span> <span class="n">inflight</span> <span class="ow">or</span> <span class="ow">not</span><span class="o">.</span>
     <span class="o">*</span> <span class="n">Only</span> <span class="n">available</span> <span class="k">for</span> <span class="n">head</span><span class="o">-</span><span class="n">descriptor</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">uint8_t</span> <span class="n">inflight</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">Padding</span> <span class="o">*/</span>
    <span class="n">uint8_t</span> <span class="n">padding</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">free</span> <span class="n">entry</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="nb">next</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">Link</span> <span class="n">to</span> <span class="n">the</span> <span class="n">last</span> <span class="n">entry</span> <span class="n">of</span> <span class="n">descriptor</span> <span class="nb">list</span><span class="o">.</span>
     <span class="o">*</span> <span class="n">Only</span> <span class="n">available</span> <span class="k">for</span> <span class="n">head</span><span class="o">-</span><span class="n">descriptor</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="n">last</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">length</span> <span class="n">of</span> <span class="n">descriptor</span> <span class="nb">list</span><span class="o">.</span>
     <span class="o">*</span> <span class="n">Only</span> <span class="n">available</span> <span class="k">for</span> <span class="n">head</span><span class="o">-</span><span class="n">descriptor</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="n">num</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">Used</span> <span class="n">to</span> <span class="n">preserve</span> <span class="n">the</span> <span class="n">order</span> <span class="n">of</span> <span class="n">fetching</span> <span class="n">available</span> <span class="n">descriptors</span><span class="o">.</span>
     <span class="o">*</span> <span class="n">Only</span> <span class="n">available</span> <span class="k">for</span> <span class="n">head</span><span class="o">-</span><span class="n">descriptor</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">uint64_t</span> <span class="n">counter</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">buffer</span> <span class="nb">id</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="nb">id</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">descriptor</span> <span class="n">flags</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="n">flags</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">buffer</span> <span class="n">length</span> <span class="o">*/</span>
    <span class="n">uint32_t</span> <span class="nb">len</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">buffer</span> <span class="n">address</span> <span class="o">*/</span>
    <span class="n">uint64_t</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">DescStatePacked</span><span class="p">;</span>

<span class="n">typedef</span> <span class="n">struct</span> <span class="n">QueueRegionPacked</span> <span class="p">{</span>
    <span class="o">/*</span> <span class="n">The</span> <span class="n">feature</span> <span class="n">flags</span> <span class="n">of</span> <span class="n">this</span> <span class="n">region</span><span class="o">.</span> <span class="n">Now</span> <span class="n">it</span><span class="s1">&#39;s initialized to 0. */</span>
    <span class="n">uint64_t</span> <span class="n">features</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">version</span> <span class="n">of</span> <span class="n">this</span> <span class="n">region</span><span class="o">.</span> <span class="n">It</span><span class="s1">&#39;s 1 currently.</span>
     <span class="o">*</span> <span class="n">Zero</span> <span class="n">value</span> <span class="n">indicates</span> <span class="n">an</span> <span class="n">uninitialized</span> <span class="n">buffer</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="n">version</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">size</span> <span class="n">of</span> <span class="n">DescStatePacked</span> <span class="n">array</span><span class="o">.</span> <span class="n">It</span><span class="s1">&#39;s equal to the virtqueue</span>
     <span class="o">*</span> <span class="n">size</span><span class="o">.</span> <span class="n">Slave</span> <span class="n">could</span> <span class="n">get</span> <span class="n">it</span> <span class="kn">from</span> <span class="nn">queue</span> <span class="n">size</span> <span class="n">field</span> <span class="n">of</span> <span class="n">VhostUserInflight</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="n">desc_num</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">head</span> <span class="n">of</span> <span class="n">free</span> <span class="n">DescStatePacked</span> <span class="n">entry</span> <span class="nb">list</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="n">free_head</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">old</span> <span class="n">head</span> <span class="n">of</span> <span class="n">free</span> <span class="n">DescStatePacked</span> <span class="n">entry</span> <span class="nb">list</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="n">old_free_head</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">used</span> <span class="n">index</span> <span class="n">of</span> <span class="n">descriptor</span> <span class="n">ring</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="n">used_idx</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">old</span> <span class="n">used</span> <span class="n">index</span> <span class="n">of</span> <span class="n">descriptor</span> <span class="n">ring</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="n">old_used_idx</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">Device</span> <span class="n">ring</span> <span class="n">wrap</span> <span class="n">counter</span> <span class="o">*/</span>
    <span class="n">uint8_t</span> <span class="n">used_wrap_counter</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">old</span> <span class="n">device</span> <span class="n">ring</span> <span class="n">wrap</span> <span class="n">counter</span> <span class="o">*/</span>
    <span class="n">uint8_t</span> <span class="n">old_used_wrap_counter</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">Padding</span> <span class="o">*/</span>
    <span class="n">uint8_t</span> <span class="n">padding</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

    <span class="o">/*</span> <span class="n">Used</span> <span class="n">to</span> <span class="n">track</span> <span class="n">the</span> <span class="n">state</span> <span class="n">of</span> <span class="n">each</span> <span class="n">descriptor</span> <span class="n">fetched</span> <span class="kn">from</span> <span class="nn">descriptor</span> <span class="n">ring</span> <span class="o">*/</span>
    <span class="n">DescStatePacked</span> <span class="n">desc</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">QueueRegionPacked</span><span class="p">;</span>
</pre></div>
</div>
<p>To track inflight I/O, the queue region should be processed as follows:</p>
<p>When receiving available buffers from the driver:</p>
<ol class="arabic simple">
<li>Get the next available descriptor entry from descriptor ring, <code class="docutils literal notranslate"><span class="pre">d</span></code></li>
<li>If <code class="docutils literal notranslate"><span class="pre">d</span></code> is head descriptor,<ol class="loweralpha">
<li>Set <code class="docutils literal notranslate"><span class="pre">desc[old_free_head].num</span></code> to 0</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">desc[old_free_head].counter</span></code> to the value of global counter</li>
<li>Increase global counter by 1</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">desc[old_free_head].inflight</span></code> to 1</li>
</ol>
</li>
<li>If <code class="docutils literal notranslate"><span class="pre">d</span></code> is last descriptor, set <code class="docutils literal notranslate"><span class="pre">desc[old_free_head].last</span></code> to
<code class="docutils literal notranslate"><span class="pre">free_head</span></code></li>
<li>Increase <code class="docutils literal notranslate"><span class="pre">desc[old_free_head].num</span></code> by 1</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">desc[free_head].addr</span></code>, <code class="docutils literal notranslate"><span class="pre">desc[free_head].len</span></code>,
<code class="docutils literal notranslate"><span class="pre">desc[free_head].flags</span></code>, <code class="docutils literal notranslate"><span class="pre">desc[free_head].id</span></code> to <code class="docutils literal notranslate"><span class="pre">d.addr</span></code>,
<code class="docutils literal notranslate"><span class="pre">d.len</span></code>, <code class="docutils literal notranslate"><span class="pre">d.flags</span></code>, <code class="docutils literal notranslate"><span class="pre">d.id</span></code></li>
<li>Set <code class="docutils literal notranslate"><span class="pre">free_head</span></code> to <code class="docutils literal notranslate"><span class="pre">desc[free_head].next</span></code></li>
<li>If <code class="docutils literal notranslate"><span class="pre">d</span></code> is last descriptor, set <code class="docutils literal notranslate"><span class="pre">old_free_head</span></code> to <code class="docutils literal notranslate"><span class="pre">free_head</span></code></li>
</ol>
<p>When supplying used buffers to the driver:</p>
<ol class="arabic simple">
<li>Get corresponding used head-descriptor entry from descriptor ring,
<code class="docutils literal notranslate"><span class="pre">d</span></code></li>
<li>Get corresponding <code class="docutils literal notranslate"><span class="pre">DescStatePacked</span></code> entry, <code class="docutils literal notranslate"><span class="pre">e</span></code></li>
<li>Set <code class="docutils literal notranslate"><span class="pre">desc[e.last].next</span></code> to <code class="docutils literal notranslate"><span class="pre">free_head</span></code></li>
<li>Set <code class="docutils literal notranslate"><span class="pre">free_head</span></code> to the index of <code class="docutils literal notranslate"><span class="pre">e</span></code></li>
<li>Steps 1,2,3,4 may be performed repeatedly if batching is possible</li>
<li>Increase <code class="docutils literal notranslate"><span class="pre">used_idx</span></code> by the size of the batch and update
<code class="docutils literal notranslate"><span class="pre">used_wrap_counter</span></code> if needed</li>
<li>Update <code class="docutils literal notranslate"><span class="pre">d.flags</span></code></li>
<li>Set the <code class="docutils literal notranslate"><span class="pre">inflight</span></code> field of each head <code class="docutils literal notranslate"><span class="pre">DescStatePacked</span></code> entry
in the batch to 0</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">old_free_head</span></code>,  <code class="docutils literal notranslate"><span class="pre">old_used_idx</span></code>, <code class="docutils literal notranslate"><span class="pre">old_used_wrap_counter</span></code>
to <code class="docutils literal notranslate"><span class="pre">free_head</span></code>, <code class="docutils literal notranslate"><span class="pre">used_idx</span></code>, <code class="docutils literal notranslate"><span class="pre">used_wrap_counter</span></code></li>
</ol>
<p>When reconnecting:</p>
<ol class="arabic simple">
<li>If <code class="docutils literal notranslate"><span class="pre">used_idx</span></code> does not match <code class="docutils literal notranslate"><span class="pre">old_used_idx</span></code> (means the
<code class="docutils literal notranslate"><span class="pre">inflight</span></code> field of <code class="docutils literal notranslate"><span class="pre">DescStatePacked</span></code> entries in last batch may
be incorrect),<ol class="loweralpha">
<li>Get the next descriptor ring entry through <code class="docutils literal notranslate"><span class="pre">old_used_idx</span></code>, <code class="docutils literal notranslate"><span class="pre">d</span></code></li>
<li>Use <code class="docutils literal notranslate"><span class="pre">old_used_wrap_counter</span></code> to calculate the available flags</li>
<li>If <code class="docutils literal notranslate"><span class="pre">d.flags</span></code> is not equal to the calculated flags value (means
slave has submitted the buffer to guest driver before crash, so
it has to commit the in-progres update), set <code class="docutils literal notranslate"><span class="pre">old_free_head</span></code>,
<code class="docutils literal notranslate"><span class="pre">old_used_idx</span></code>, <code class="docutils literal notranslate"><span class="pre">old_used_wrap_counter</span></code> to <code class="docutils literal notranslate"><span class="pre">free_head</span></code>,
<code class="docutils literal notranslate"><span class="pre">used_idx</span></code>, <code class="docutils literal notranslate"><span class="pre">used_wrap_counter</span></code></li>
</ol>
</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">free_head</span></code>, <code class="docutils literal notranslate"><span class="pre">used_idx</span></code>, <code class="docutils literal notranslate"><span class="pre">used_wrap_counter</span></code> to
<code class="docutils literal notranslate"><span class="pre">old_free_head</span></code>, <code class="docutils literal notranslate"><span class="pre">old_used_idx</span></code>, <code class="docutils literal notranslate"><span class="pre">old_used_wrap_counter</span></code>
(roll back any in-progress update)</li>
<li>Set the <code class="docutils literal notranslate"><span class="pre">inflight</span></code> field of each <code class="docutils literal notranslate"><span class="pre">DescStatePacked</span></code> entry in
free list to 0</li>
<li>Resubmit inflight <code class="docutils literal notranslate"><span class="pre">DescStatePacked</span></code> entries in order of their
counter value</li>
</ol>
</div>
<div class="section" id="in-band-notifications">
<h3><a class="toc-backref" href="#id26">In-band notifications</a><a class="headerlink" href="#in-band-notifications" title="Permalink to this headline">¶</a></h3>
<p>In some limited situations (e.g. for simulation) it is desirable to
have the kick, call and error (if used) signals done via in-band
messages instead of asynchronous eventfd notifications. This can be
done by negotiating the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_INBAND_NOTIFICATIONS</span></code>
protocol feature.</p>
<p>Note that due to the fact that too many messages on the sockets can
cause the sending application(s) to block, it is not advised to use
this feature unless absolutely necessary. It is also considered an
error to negotiate this feature without also negotiating
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_SLAVE_REQ</span></code> and <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_REPLY_ACK</span></code>,
the former is necessary for getting a message channel from the slave
to the master, while the latter needs to be used with the in-band
notification messages to block until they are processed, both to avoid
blocking later and for proper processing (at least in the simulation
use case.) As it has no other way of signalling this error, the slave
should close the connection as a response to a
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_PROTOCOL_FEATURES</span></code> message that sets the in-band
notifications feature flag without the other two.</p>
</div>
<div class="section" id="protocol-features">
<h3><a class="toc-backref" href="#id27">Protocol features</a><a class="headerlink" href="#protocol-features" title="Permalink to this headline">¶</a></h3>
<div class="code c highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define VHOST_USER_PROTOCOL_F_MQ                    0</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_LOG_SHMFD             1</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_RARP                  2</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_REPLY_ACK             3</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_MTU                   4</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_SLAVE_REQ             5</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_CROSS_ENDIAN          6</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_CRYPTO_SESSION        7</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_PAGEFAULT             8</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_CONFIG                9</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_SLAVE_SEND_FD        10</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_HOST_NOTIFIER        11</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_INFLIGHT_SHMFD       12</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_RESET_DEVICE         13</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_INBAND_NOTIFICATIONS 14</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_CONFIGURE_MEM_SLOTS  15</span>
<span class="c1">#define VHOST_USER_PROTOCOL_F_STATUS               16</span>
</pre></div>
</div>
</div>
<div class="section" id="master-message-types">
<h3><a class="toc-backref" href="#id28">Master message types</a><a class="headerlink" href="#master-message-types" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_FEATURES</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">1</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_GET_FEATURES</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
<tr class="field-even field"><th class="field-name">slave payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">u64</span></code></td>
</tr>
</tbody>
</table>
<p class="last">Get from the underlying vhost implementation the features bitmask.
Feature bit <code class="docutils literal notranslate"><span class="pre">VHOST_USER_F_PROTOCOL_FEATURES</span></code> signals slave support
for <code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_PROTOCOL_FEATURES</span></code> and
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_PROTOCOL_FEATURES</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_FEATURES</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">2</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_SET_FEATURES</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">u64</span></code></td>
</tr>
</tbody>
</table>
<p class="last">Enable features in the underlying vhost implementation using a
bitmask.  Feature bit <code class="docutils literal notranslate"><span class="pre">VHOST_USER_F_PROTOCOL_FEATURES</span></code> signals
slave support for <code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_PROTOCOL_FEATURES</span></code> and
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_PROTOCOL_FEATURES</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_PROTOCOL_FEATURES</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">15</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_GET_FEATURES</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
<tr class="field-even field"><th class="field-name">slave payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">u64</span></code></td>
</tr>
</tbody>
</table>
<p class="last">Get the protocol feature bitmask from the underlying vhost
implementation.  Only legal if feature bit
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_F_PROTOCOL_FEATURES</span></code> is present in
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_FEATURES</span></code>.</p>
</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Slave that reported <code class="docutils literal notranslate"><span class="pre">VHOST_USER_F_PROTOCOL_FEATURES</span></code> must
support this message even before <code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_FEATURES</span></code> was
called.</p>
</div>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_PROTOCOL_FEATURES</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">16</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_SET_FEATURES</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">u64</span></code></td>
</tr>
</tbody>
</table>
<p>Enable protocol features in the underlying vhost implementation.</p>
<p class="last">Only legal if feature bit <code class="docutils literal notranslate"><span class="pre">VHOST_USER_F_PROTOCOL_FEATURES</span></code> is present in
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_FEATURES</span></code>.</p>
</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Slave that reported <code class="docutils literal notranslate"><span class="pre">VHOST_USER_F_PROTOCOL_FEATURES</span></code> must support
this message even before <code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_FEATURES</span></code> was called.</p>
</div>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_OWNER</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">3</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_SET_OWNER</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p class="last">Issued when a new connection is established. It sets the current
<em>master</em> as an owner of the session. This can be used on the <em>slave</em>
as a “session start” flag.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_RESET_OWNER</span></code></dt>
<dd><table class="first last docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">4</td>
</tr>
<tr class="field-even field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
</dd>
</dl>
<div class="admonition-deprecated admonition">
<p class="first admonition-title">Deprecated</p>
<p class="last">This is no longer used. Used to be sent to request disabling all
rings, but some clients interpreted it to also discard connection
state (this interpretation would lead to bugs).  It is recommended
that clients either ignore this message, or use it to disable all
rings.</p>
</div>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_MEM_TABLE</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">5</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_SET_MEM_TABLE</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">memory regions description</td>
</tr>
<tr class="field-even field"><th class="field-name">slave payload:</th><td class="field-body">(postcopy only) memory regions description</td>
</tr>
</tbody>
</table>
<p>Sets the memory map regions on the slave so it can translate the
vring addresses. In the ancillary data there is an array of file
descriptors for each memory mapped region. The size and ordering of
the fds matches the number and ordering of memory regions.</p>
<p class="last">When <code class="docutils literal notranslate"><span class="pre">VHOST_USER_POSTCOPY_LISTEN</span></code> has been received,
<code class="docutils literal notranslate"><span class="pre">SET_MEM_TABLE</span></code> replies with the bases of the memory mapped
regions to the master.  The slave must have mmap’d the regions but
not yet accessed them and should not yet generate a userfault
event.</p>
</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">NEED_REPLY_MASK</span></code> is not set in this case.  QEMU will then
reply back to the list of mappings with an empty
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_MEM_TABLE</span></code> as an acknowledgement; only upon
reception of this message may the guest start accessing the memory
and generating faults.</p>
</div>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_LOG_BASE</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">6</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_SET_LOG_BASE</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">u64</td>
</tr>
<tr class="field-even field"><th class="field-name">slave payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p>Sets logging shared memory space.</p>
<p class="last">When slave has <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_LOG_SHMFD</span></code> protocol feature,
the log memory fd is provided in the ancillary data of
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_LOG_BASE</span></code> message, the size and offset of shared
memory area provided in the message.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_LOG_FD</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">7</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_SET_LOG_FD</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p class="last">Sets the logging file descriptor, which is passed as ancillary data.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_NUM</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">8</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_SET_VRING_NUM</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">vring state description</td>
</tr>
</tbody>
</table>
<p class="last">Set the size of the queue.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_ADDR</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">9</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_SET_VRING_ADDR</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">vring address description</td>
</tr>
<tr class="field-even field"><th class="field-name">slave payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p class="last">Sets the addresses of the different aspects of the vring.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_BASE</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">10</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_SET_VRING_BASE</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">vring state description</td>
</tr>
</tbody>
</table>
<p class="last">Sets the base offset in the available vring.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_VRING_BASE</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">11</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_VRING_BASE</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">vring state description</td>
</tr>
<tr class="field-even field"><th class="field-name">slave payload:</th><td class="field-body">vring state description</td>
</tr>
</tbody>
</table>
<p class="last">Get the available vring base offset.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_KICK</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">12</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_SET_VRING_KICK</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">u64</span></code></td>
</tr>
</tbody>
</table>
<p>Set the event file descriptor for adding buffers to the vring. It is
passed in the ancillary data.</p>
<p class="last">Bits (0-7) of the payload contain the vring index. Bit 8 is the
invalid FD flag. This flag is set when there is no file descriptor
in the ancillary data. This signals that polling should be used
instead of waiting for the kick. Note that if the protocol feature
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_INBAND_NOTIFICATIONS</span></code> has been negotiated
this message isn’t necessary as the ring is also started on the
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_VRING_KICK</span></code> message, it may however still be used to
set an event file descriptor (which will be preferred over the
message) or to enable polling.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_CALL</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">13</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_SET_VRING_CALL</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">u64</span></code></td>
</tr>
</tbody>
</table>
<p>Set the event file descriptor to signal when buffers are used. It is
passed in the ancillary data.</p>
<p class="last">Bits (0-7) of the payload contain the vring index. Bit 8 is the
invalid FD flag. This flag is set when there is no file descriptor
in the ancillary data. This signals that polling will be used
instead of waiting for the call. Note that if the protocol features
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_INBAND_NOTIFICATIONS</span></code> and
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_SLAVE_REQ</span></code> have been negotiated this message
isn’t necessary as the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_SLAVE_VRING_CALL</span></code> message can be
used, it may however still be used to set an event file descriptor
or to enable polling.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_ERR</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">14</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_SET_VRING_ERR</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">u64</span></code></td>
</tr>
</tbody>
</table>
<p>Set the event file descriptor to signal when error occurs. It is
passed in the ancillary data.</p>
<p class="last">Bits (0-7) of the payload contain the vring index. Bit 8 is the
invalid FD flag. This flag is set when there is no file descriptor
in the ancillary data. Note that if the protocol features
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_INBAND_NOTIFICATIONS</span></code> and
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_SLAVE_REQ</span></code> have been negotiated this message
isn’t necessary as the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_SLAVE_VRING_ERR</span></code> message can be
used, it may however still be used to set an event file descriptor
(which will be preferred over the message).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_QUEUE_NUM</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">17</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
<tr class="field-even field"><th class="field-name">slave payload:</th><td class="field-body">u64</td>
</tr>
</tbody>
</table>
<p>Query how many queues the backend supports.</p>
<p class="last">This request should be sent only when <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_MQ</span></code>
is set in queried protocol features by
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_PROTOCOL_FEATURES</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_ENABLE</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">18</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">vring state description</td>
</tr>
</tbody>
</table>
<p>Signal slave to enable or disable corresponding vring.</p>
<p class="last">This request should be sent only when
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_F_PROTOCOL_FEATURES</span></code> has been negotiated.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SEND_RARP</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">19</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">u64</span></code></td>
</tr>
</tbody>
</table>
<p>Ask vhost user backend to broadcast a fake RARP to notify the migration
is terminated for guest that does not support GUEST_ANNOUNCE.</p>
<p class="last">Only legal if feature bit <code class="docutils literal notranslate"><span class="pre">VHOST_USER_F_PROTOCOL_FEATURES</span></code> is
present in <code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_FEATURES</span></code> and protocol feature bit
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_RARP</span></code> is present in
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_PROTOCOL_FEATURES</span></code>.  The first 6 bytes of the
payload contain the mac address of the guest to allow the vhost user
backend to construct and broadcast the fake RARP.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_NET_SET_MTU</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">20</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">u64</span></code></td>
</tr>
</tbody>
</table>
<p>Set host MTU value exposed to the guest.</p>
<p>This request should be sent only when <code class="docutils literal notranslate"><span class="pre">VIRTIO_NET_F_MTU</span></code> feature
has been successfully negotiated, <code class="docutils literal notranslate"><span class="pre">VHOST_USER_F_PROTOCOL_FEATURES</span></code>
is present in <code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_FEATURES</span></code> and protocol feature bit
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_NET_MTU</span></code> is present in
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_PROTOCOL_FEATURES</span></code>.</p>
<p class="last">If <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_REPLY_ACK</span></code> is negotiated, slave must
respond with zero in case the specified MTU is valid, or non-zero
otherwise.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_SLAVE_REQ_FD</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">21</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p>Set the socket file descriptor for slave initiated requests. It is passed
in the ancillary data.</p>
<p class="last">This request should be sent only when
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_F_PROTOCOL_FEATURES</span></code> has been negotiated, and protocol
feature bit <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_SLAVE_REQ</span></code> bit is present in
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_PROTOCOL_FEATURES</span></code>.  If
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_REPLY_ACK</span></code> is negotiated, slave must
respond with zero for success, non-zero otherwise.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_IOTLB_MSG</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">22</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A (equivalent to <code class="docutils literal notranslate"><span class="pre">VHOST_IOTLB_MSG</span></code> message type)</td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">vhost_iotlb_msg</span></code></td>
</tr>
<tr class="field-even field"><th class="field-name">slave payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">u64</span></code></td>
</tr>
</tbody>
</table>
<p>Send IOTLB messages with <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">vhost_iotlb_msg</span></code> as payload.</p>
<p>Master sends such requests to update and invalidate entries in the
device IOTLB. The slave has to acknowledge the request with sending
zero as <code class="docutils literal notranslate"><span class="pre">u64</span></code> payload for success, non-zero otherwise.</p>
<p class="last">This request should be send only when <code class="docutils literal notranslate"><span class="pre">VIRTIO_F_IOMMU_PLATFORM</span></code>
feature has been successfully negotiated.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_ENDIAN</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">23</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><code class="docutils literal notranslate"><span class="pre">VHOST_SET_VRING_ENDIAN</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">vring state description</td>
</tr>
</tbody>
</table>
<p>Set the endianness of a VQ for legacy devices. Little-endian is
indicated with state.num set to 0 and big-endian is indicated with
state.num set to 1. Other values are invalid.</p>
<p class="last">This request should be sent only when
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_CROSS_ENDIAN</span></code> has been negotiated.
Backends that negotiated this feature should handle both
endiannesses and expect this message once (per VQ) during device
configuration (ie. before the master starts the VQ).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_CONFIG</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">24</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">virtio device config space</td>
</tr>
<tr class="field-even field"><th class="field-name">slave payload:</th><td class="field-body">virtio device config space</td>
</tr>
</tbody>
</table>
<p class="last">When <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_CONFIG</span></code> is negotiated, this message is
submitted by the vhost-user master to fetch the contents of the
virtio device configuration space, vhost-user slave’s payload size
MUST match master’s request, vhost-user slave uses zero length of
payload to indicate an error to vhost-user master. The vhost-user
master may cache the contents to avoid repeated
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_CONFIG</span></code> calls.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_CONFIG</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">25</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">virtio device config space</td>
</tr>
<tr class="field-even field"><th class="field-name">slave payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p class="last">When <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_CONFIG</span></code> is negotiated, this message is
submitted by the vhost-user master when the Guest changes the virtio
device configuration space and also can be used for live migration
on the destination host. The vhost-user slave must check the flags
field, and slaves MUST NOT accept SET_CONFIG for read-only
configuration space fields unless the live migration bit is set.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_CREATE_CRYPTO_SESSION</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">26</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">crypto session description</td>
</tr>
<tr class="field-even field"><th class="field-name">slave payload:</th><td class="field-body">crypto session description</td>
</tr>
</tbody>
</table>
<p class="last">Create a session for crypto operation. The server side must return
the session id, 0 or positive for success, negative for failure.
This request should be sent only when
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_CRYPTO_SESSION</span></code> feature has been
successfully negotiated.  It’s a required feature for crypto
devices.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_CLOSE_CRYPTO_SESSION</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">27</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">u64</span></code></td>
</tr>
</tbody>
</table>
<p>Close a session for crypto operation which was previously
created by <code class="docutils literal notranslate"><span class="pre">VHOST_USER_CREATE_CRYPTO_SESSION</span></code>.</p>
<p class="last">This request should be sent only when
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_CRYPTO_SESSION</span></code> feature has been
successfully negotiated.  It’s a required feature for crypto
devices.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_POSTCOPY_ADVISE</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">28</td>
</tr>
<tr class="field-even field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">slave payload:</th><td class="field-body">userfault fd</td>
</tr>
</tbody>
</table>
<p class="last">When <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_PAGEFAULT</span></code> is supported, the master
advises slave that a migration with postcopy enabled is underway,
the slave must open a userfaultfd for later use.  Note that at this
stage the migration is still in precopy mode.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_POSTCOPY_LISTEN</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">29</td>
</tr>
<tr class="field-even field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p>Master advises slave that a transition to postcopy mode has
happened.  The slave must ensure that shared memory is registered
with userfaultfd to cause faulting of non-present pages.</p>
<p class="last">This is always sent sometime after a <code class="docutils literal notranslate"><span class="pre">VHOST_USER_POSTCOPY_ADVISE</span></code>,
and thus only when <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_PAGEFAULT</span></code> is supported.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_POSTCOPY_END</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">30</td>
</tr>
<tr class="field-even field"><th class="field-name">slave payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">u64</span></code></td>
</tr>
</tbody>
</table>
<p>Master advises that postcopy migration has now completed.  The slave
must disable the userfaultfd. The response is an acknowledgement
only.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_PAGEFAULT</span></code> is supported, this message
is sent at the end of the migration, after
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_POSTCOPY_LISTEN</span></code> was previously sent.</p>
<p class="last">The value returned is an error indication; 0 is success.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_INFLIGHT_FD</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">31</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">inflight description</td>
</tr>
</tbody>
</table>
<p class="last">When <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_INFLIGHT_SHMFD</span></code> protocol feature has
been successfully negotiated, this message is submitted by master to
get a shared buffer from slave. The shared buffer will be used to
track inflight I/O by slave. QEMU should retrieve a new one when vm
reset.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_INFLIGHT_FD</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">32</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">inflight description</td>
</tr>
</tbody>
</table>
<p class="last">When <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_INFLIGHT_SHMFD</span></code> protocol feature has
been successfully negotiated, this message is submitted by master to
send the shared inflight buffer back to slave so that slave could
get inflight I/O after a crash or restart.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_GPU_SET_SOCKET</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">33</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p class="last">Sets the GPU protocol socket file descriptor, which is passed as
ancillary data. The GPU protocol is used to inform the master of
rendering state and updates. See vhost-user-gpu.rst for details.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_RESET_DEVICE</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">34</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
<tr class="field-even field"><th class="field-name">slave payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p>Ask the vhost user backend to disable all rings and reset all
internal device state to the initial state, ready to be
reinitialized. The backend retains ownership of the device
throughout the reset operation.</p>
<p class="last">Only valid if the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_RESET_DEVICE</span></code> protocol
feature is set by the backend.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_VRING_KICK</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">35</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">slave payload:</th><td class="field-body">vring state description</td>
</tr>
<tr class="field-even field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p>When the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_INBAND_NOTIFICATIONS</span></code> protocol
feature has been successfully negotiated, this message may be
submitted by the master to indicate that a buffer was added to
the vring instead of signalling it using the vring’s kick file
descriptor or having the slave rely on polling.</p>
<p class="last">The state.num field is currently reserved and must be set to 0.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_MAX_MEM_SLOTS</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">36</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">slave payload:</th><td class="field-body">u64</td>
</tr>
</tbody>
</table>
<p class="last">When the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_CONFIGURE_MEM_SLOTS</span></code> protocol
feature has been successfully negotiated, this message is submitted
by master to the slave. The slave should return the message with a
u64 payload containing the maximum number of memory slots for
QEMU to expose to the guest. The value returned by the backend
will be capped at the maximum number of ram slots which can be
supported by the target platform.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_ADD_MEM_REG</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">37</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">slave payload:</th><td class="field-body">single memory region description</td>
</tr>
</tbody>
</table>
<p class="last">When the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_CONFIGURE_MEM_SLOTS</span></code> protocol
feature has been successfully negotiated, this message is submitted
by the master to the slave. The message payload contains a memory
region descriptor struct, describing a region of guest memory which
the slave device must map in. When the
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_CONFIGURE_MEM_SLOTS</span></code> protocol feature has
been successfully negotiated, along with the
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_REM_MEM_REG</span></code> message, this message is used to set and
update the memory tables of the slave device.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_REM_MEM_REG</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">38</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">slave payload:</th><td class="field-body">single memory region description</td>
</tr>
</tbody>
</table>
<p class="last">When the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_CONFIGURE_MEM_SLOTS</span></code> protocol
feature has been successfully negotiated, this message is submitted
by the master to the slave. The message payload contains a memory
region descriptor struct, describing a region of guest memory which
the slave device must unmap. When the
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_CONFIGURE_MEM_SLOTS</span></code> protocol feature has
been successfully negotiated, along with the
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_ADD_MEM_REG</span></code> message, this message is used to set and
update the memory tables of the slave device.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_STATUS</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">39</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">VHOST_VDPA_SET_STATUS</td>
</tr>
<tr class="field-odd field"><th class="field-name">slave payload:</th><td class="field-body">N/A</td>
</tr>
<tr class="field-even field"><th class="field-name">master payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">u64</span></code></td>
</tr>
</tbody>
</table>
<p class="last">When the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_STATUS</span></code> protocol feature has been
successfully negotiated, this message is submitted by the master to
notify the backend with updated device status as defined in the Virtio
specification.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_STATUS</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">40</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">VHOST_VDPA_GET_STATUS</td>
</tr>
<tr class="field-odd field"><th class="field-name">slave payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">u64</span></code></td>
</tr>
<tr class="field-even field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p class="last">When the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_STATUS</span></code> protocol feature has been
successfully negotiated, this message is submitted by the master to
query the backend for its device status as defined in the Virtio
specification.</p>
</dd>
</dl>
</div>
<div class="section" id="slave-message-types">
<h3><a class="toc-backref" href="#id29">Slave message types</a><a class="headerlink" href="#slave-message-types" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SLAVE_IOTLB_MSG</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">1</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A (equivalent to <code class="docutils literal notranslate"><span class="pre">VHOST_IOTLB_MSG</span></code> message type)</td>
</tr>
<tr class="field-odd field"><th class="field-name">slave payload:</th><td class="field-body"><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">vhost_iotlb_msg</span></code></td>
</tr>
<tr class="field-even field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p class="last">Send IOTLB messages with <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">vhost_iotlb_msg</span></code> as payload.
Slave sends such requests to notify of an IOTLB miss, or an IOTLB
access failure. If <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_REPLY_ACK</span></code> is
negotiated, and slave set the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_NEED_REPLY</span></code> flag, master
must respond with zero when operation is successfully completed, or
non-zero otherwise.  This request should be send only when
<code class="docutils literal notranslate"><span class="pre">VIRTIO_F_IOMMU_PLATFORM</span></code> feature has been successfully
negotiated.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SLAVE_CONFIG_CHANGE_MSG</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">2</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">slave payload:</th><td class="field-body">N/A</td>
</tr>
<tr class="field-even field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p class="last">When <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_CONFIG</span></code> is negotiated, vhost-user
slave sends such messages to notify that the virtio device’s
configuration space has changed, for those host devices which can
support such feature, host driver can send <code class="docutils literal notranslate"><span class="pre">VHOST_USER_GET_CONFIG</span></code>
message to slave to get the latest content. If
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_REPLY_ACK</span></code> is negotiated, and slave set the
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_NEED_REPLY</span></code> flag, master must respond with zero when
operation is successfully completed, or non-zero otherwise.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SLAVE_VRING_HOST_NOTIFIER_MSG</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">3</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">slave payload:</th><td class="field-body">vring area description</td>
</tr>
<tr class="field-even field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p>Sets host notifier for a specified queue. The queue index is
contained in the <code class="docutils literal notranslate"><span class="pre">u64</span></code> field of the vring area description. The
host notifier is described by the file descriptor (typically it’s a
VFIO device fd) which is passed as ancillary data and the size
(which is mmap size and should be the same as host page size) and
offset (which is mmap offset) carried in the vring area
description. QEMU can mmap the file descriptor based on the size and
offset to get a memory range. Registering a host notifier means
mapping this memory range to the VM as the specified queue’s notify
MMIO region. Slave sends this request to tell QEMU to de-register
the existing notifier if any and register the new notifier if the
request is sent with a file descriptor.</p>
<p class="last">This request should be sent only when
<code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_HOST_NOTIFIER</span></code> protocol feature has been
successfully negotiated.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SLAVE_VRING_CALL</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">4</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">slave payload:</th><td class="field-body">vring state description</td>
</tr>
<tr class="field-even field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p>When the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_INBAND_NOTIFICATIONS</span></code> protocol
feature has been successfully negotiated, this message may be
submitted by the slave to indicate that a buffer was used from
the vring instead of signalling this using the vring’s call file
descriptor or having the master relying on polling.</p>
<p class="last">The state.num field is currently reserved and must be set to 0.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VHOST_USER_SLAVE_VRING_ERR</span></code></dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">id:</th><td class="field-body">5</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">equivalent ioctl:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body">N/A</td>
</tr>
<tr class="field-odd field"><th class="field-name">slave payload:</th><td class="field-body">vring state description</td>
</tr>
<tr class="field-even field"><th class="field-name">master payload:</th><td class="field-body">N/A</td>
</tr>
</tbody>
</table>
<p>When the <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_INBAND_NOTIFICATIONS</span></code> protocol
feature has been successfully negotiated, this message may be
submitted by the slave to indicate that an error occurred on the
specific vring, instead of signalling the error file descriptor
set by the master via <code class="docutils literal notranslate"><span class="pre">VHOST_USER_SET_VRING_ERR</span></code>.</p>
<p class="last">The state.num field is currently reserved and must be set to 0.</p>
</dd>
</dl>
</div>
<div class="section" id="vhost-user-protocol-f-reply-ack">
<span id="reply-ack"></span><h3><a class="toc-backref" href="#id30">VHOST_USER_PROTOCOL_F_REPLY_ACK</a><a class="headerlink" href="#vhost-user-protocol-f-reply-ack" title="Permalink to this headline">¶</a></h3>
<p>The original vhost-user specification only demands replies for certain
commands. This differs from the vhost protocol implementation where
commands are sent over an <code class="docutils literal notranslate"><span class="pre">ioctl()</span></code> call and block until the client
has completed.</p>
<p>With this protocol extension negotiated, the sender (QEMU) can set the
<code class="docutils literal notranslate"><span class="pre">need_reply</span></code> [Bit 3] flag to any command. This indicates that the
client MUST respond with a Payload <code class="docutils literal notranslate"><span class="pre">VhostUserMsg</span></code> indicating success
or failure. The payload should be set to zero on success or non-zero
on failure, unless the message already has an explicit reply body.</p>
<p>The response payload gives QEMU a deterministic indication of the result
of the command. Today, QEMU is expected to terminate the main vhost-user
loop upon receiving such errors. In future, qemu could be taught to be more
resilient for selective requests.</p>
<p>For the message types that already solicit a reply from the client,
the presence of <code class="docutils literal notranslate"><span class="pre">VHOST_USER_PROTOCOL_F_REPLY_ACK</span></code> or need_reply bit
being set brings no behavioural change. (See the <a class="reference internal" href="#communication">Communication</a>
section for details.)</p>
</div>
</div>
<div class="section" id="backend-program-conventions">
<span id="backend-conventions"></span><h2><a class="toc-backref" href="#id31">Backend program conventions</a><a class="headerlink" href="#backend-program-conventions" title="Permalink to this headline">¶</a></h2>
<p>vhost-user backends can provide various devices &amp; services and may
need to be configured manually depending on the use case. However, it
is a good idea to follow the conventions listed here when
possible. Users, QEMU or libvirt, can then rely on some common
behaviour to avoid heterogeneous configuration and management of the
backend programs and facilitate interoperability.</p>
<p>Each backend installed on a host system should come with at least one
JSON file that conforms to the vhost-user.json schema. Each file
informs the management applications about the backend type, and binary
location. In addition, it defines rules for management apps for
picking the highest priority backend when multiple match the search
criteria (see <code class="docutils literal notranslate"><span class="pre">&#64;VhostUserBackend</span></code> documentation in the schema file).</p>
<p>If the backend is not capable of enabling a requested feature on the
host (such as 3D acceleration with virgl), or the initialization
failed, the backend should fail to start early and exit with a status
!= 0. It may also print a message to stderr for further details.</p>
<p>The backend program must not daemonize itself, but it may be
daemonized by the management layer. It may also have a restricted
access to the system.</p>
<p>File descriptors 0, 1 and 2 will exist, and have regular
stdin/stdout/stderr usage (they may have been redirected to /dev/null
by the management layer, or to a log handler).</p>
<p>The backend program must end (as quickly and cleanly as possible) when
the SIGTERM signal is received. Eventually, it may receive SIGKILL by
the management layer after a few seconds.</p>
<p>The following command line options have an expected behaviour. They
are mandatory, unless explicitly said differently:</p>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--socket-path=<var>PATH</var></span></kbd></td>
</tr>
<tr><td>&#160;</td><td>This option specify the location of the vhost-user Unix domain socket.
It is incompatible with –fd.</td></tr>
<tr><td class="option-group">
<kbd><span class="option">--fd=<var>FDNUM</var></span></kbd></td>
<td>When this argument is given, the backend program is started with the
vhost-user socket as file descriptor FDNUM. It is incompatible with
–socket-path.</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--print-capabilities</span></kbd></td>
</tr>
<tr><td>&#160;</td><td>Output to stdout the backend capabilities in JSON format, and then
exit successfully. Other options and arguments should be ignored, and
the backend program should not perform its normal function.  The
capabilities can be reported dynamically depending on the host
capabilities.</td></tr>
</tbody>
</table>
<p>The JSON output is described in the <code class="docutils literal notranslate"><span class="pre">vhost-user.json</span></code> schema, by
<code class="docutils literal notranslate"><span class="pre">`&#64;VHostUserBackendCapabilities</span></code>.  Example:</p>
<div class="code json highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span>
  <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;feature-a&quot;</span><span class="p">,</span>
    <span class="s2">&quot;feature-b&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="vhost-user-input">
<h3><a class="toc-backref" href="#id32">vhost-user-input</a><a class="headerlink" href="#vhost-user-input" title="Permalink to this headline">¶</a></h3>
<p>Command line options:</p>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--evdev-path=<var>PATH</var></span></kbd></td>
</tr>
<tr><td>&#160;</td><td><p class="first">Specify the linux input device.</p>
<p class="last">(optional)</p>
</td></tr>
<tr><td class="option-group">
<kbd><span class="option">--no-grab</span></kbd></td>
<td><p class="first">Do no request exclusive access to the input device.</p>
<p class="last">(optional)</p>
</td></tr>
</tbody>
</table>
</div>
<div class="section" id="vhost-user-gpu">
<h3><a class="toc-backref" href="#id33">vhost-user-gpu</a><a class="headerlink" href="#vhost-user-gpu" title="Permalink to this headline">¶</a></h3>
<p>Command line options:</p>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--render-node=<var>PATH</var></span></kbd></td>
</tr>
<tr><td>&#160;</td><td><p class="first">Specify the GPU DRM render node.</p>
<p class="last">(optional)</p>
</td></tr>
<tr><td class="option-group">
<kbd><span class="option">--virgl</span></kbd></td>
<td><p class="first">Enable virgl rendering support.</p>
<p class="last">(optional)</p>
</td></tr>
</tbody>
</table>
</div>
<div class="section" id="vhost-user-blk">
<h3><a class="toc-backref" href="#id34">vhost-user-blk</a><a class="headerlink" href="#vhost-user-blk" title="Permalink to this headline">¶</a></h3>
<p>Command line options:</p>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--blk-file=<var>PATH</var></span></kbd></td>
</tr>
<tr><td>&#160;</td><td><p class="first">Specify block device or file path.</p>
<p class="last">(optional)</p>
</td></tr>
<tr><td class="option-group">
<kbd><span class="option">--read-only</span></kbd></td>
<td><p class="first">Enable read-only.</p>
<p class="last">(optional)</p>
</td></tr>
</tbody>
</table>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">QEMU</a></h1>



<p class="blurb">System Emulation Management and Interoperability Guide</p>






<div id="editpage">
  <ul>
    <li><a href="https://gitlab.com/qemu-project/qemu/-/blob/master/docs/interop/vhost-user.rst">Page source</a></li>
  </ul>
</div><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="bitmaps.html">Dirty Bitmaps and Incremental Backup</a></li>
<li class="toctree-l1"><a class="reference internal" href="dbus.html">D-Bus</a></li>
<li class="toctree-l1"><a class="reference internal" href="dbus-vmstate.html">D-Bus VMState</a></li>
<li class="toctree-l1"><a class="reference internal" href="live-block-operations.html">Live Block Device Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="pr-helper.html">Persistent reservation helper protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="qemu-ga.html">QEMU Guest Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="qemu-ga-ref.html">QEMU Guest Agent Protocol Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="qemu-qmp-ref.html">QEMU QMP Reference Manual</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Vhost-user Protocol</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#message-specification">Message Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="#communication">Communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="#backend-program-conventions">Backend program conventions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="vhost-user-gpu.html">Vhost-user-gpu Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="vhost-vdpa.html">Vhost-vdpa Protocol</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, The QEMU Project Developers.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>